classdef PupilPlaneClass
    properties
        rho
        theta
        Bstar
        THETAplate 
        THETAZernike 
    end
    methods
        function out = init(PupilPlane,FileName)            
            %below is the original Rabinowitz and Richter coordinates and 
            %the weights. from A survey of known and a new cubature 
            %formulas for the unit disk by Ronald Cools all of these are 
            %calcualted on the unit disk natively and in the Gibson-Lani 
            %model.
            
            r=[0.18089963670914432,...
                0.98391537714755427,...
                0.77364389614737803,...
                0.67975937134823609,...
                0.59230560995561076,...
                0.41774444740353380,...
                0.89789289495208579,...
                0.93927352486965313,...
                0.79099671385625722,...
                0.56605481445792489,...
                0.83180776468445906,...
                0.76010583069266321,...
                0.62209339812108792,...
                0.36200059276768541];
            s=[0.0,...
                0.0,...
                0.77364389614737803,...
                0.67975937134823609,...
                0.59230560995561076,...
                0.41774444740353380,...
                0.13375169526590821,...
                0.27985732696474981,...
                0.39385576573951899,...
                0.10885005806786229,...
                0.51224072541565606,...
                0.12830595415488073,...
                0.34691040719842391,...
                0.16676191877222966];
            B=[0.064712088156233115,...
                0.012203257346077736,...
                4.6214466764876138e-5,...
                0.020941123674084990,...
                0.044321766954122515,...
                0.052715691149269700,...
                0.028690025849304919,...
                0.013819709344648730,...
                0.037034888202855274,...
                0.047520136607474831,...
                0.014296165120136605,...
                0.042923763669888949,...
                0.047444099811669938,...
                0.063500222219468438];
            
            B_vec=[];
            rs=[];
            for ii=1:numel(r)
                if (r(ii)==s(ii))
                    rs_temp=[r(ii),-r(ii),-r(ii),r(ii);...
                             s(ii),s(ii),-s(ii),-s(ii)];
            
                    B_temp=[B(ii),B(ii),B(ii),B(ii)]; 
                elseif (r(ii)~=s(ii))
                    if s(ii)==0
                        rs_temp=[r(ii),-r(ii),s(ii),s(ii);...
                                s(ii),s(ii),r(ii),-r(ii)];
            
                        B_temp=[B(ii),B(ii),B(ii),B(ii)]; 
                    elseif s(ii)~=0
                        rs_temp=[r(ii),-r(ii),-r(ii),r(ii),s(ii),-s(ii),-s(ii),s(ii);...
                                s(ii),s(ii),-s(ii),-s(ii),r(ii),r(ii),-r(ii),-r(ii)];
            
                        B_temp=[B(ii),B(ii),B(ii),B(ii),B(ii),B(ii),B(ii),B(ii)]; 
                    end
                end
                rs=cat(2,rs,rs_temp);
                B_vec=cat(2,B_vec,B_temp);
            end
    
            rt=zeros(size(rs));
            for ii=1:size(rs,2)
                rt(1,ii)=sqrt(rs(1,ii)^2+rs(2,ii)^2);
                rt(2,ii)=atan2(rs(2,ii),rs(1,ii));    
            end
            PupilPlane.Bstar=single(B_vec);
            PupilPlane.rho=single(rt(1,:));
            PupilPlane.theta=single(rt(2,:));
            
            % Assign zero arrays of size Bstar
            PupilPlane.THETAplate=single(zeros(size(B_vec)));
            PupilPlane.THETAZernike=single(zeros(size(B_vec)));
            
            % pupil plane array
            PupilPlaneArray=cat(1,PupilPlane.Bstar,...
                                  PupilPlane.rho,...
                                  PupilPlane.theta,...
                                  PupilPlane.THETAplate,...
                                  PupilPlane.THETAZernike);
            PupilPlaneArray=mat2cell(PupilPlaneArray,...
                                     ones(1,size(PupilPlaneArray,1)));                  
            strcell={'Bstar';...
                     'rho';...
                     'theta';...
                     'THETAplate';...
                     'THETAZernike'};
            PupilPlaneArray=cat(2,strcell,PupilPlaneArray);
            
            PupilPlaneFileName=strcat(FileName);
            writecell(PupilPlaneArray,PupilPlaneFileName,'Delimiter','comma');
            
            out = PupilPlane;
        end
        function out = write(PupilPlane,FileName)
            % pupil plane array
            PupilPlaneArray=cat(1,PupilPlane.Bstar,...
                                  PupilPlane.rho,...
                                  PupilPlane.theta,...
                                  PupilPlane.THETAplate,...
                                  PupilPlane.THETAZernike);
            PupilPlaneArray=mat2cell(PupilPlaneArray,...
                                     ones(1,size(PupilPlaneArray,1)));                  
            strcell={'Bstar';...
                     'rho';...
                     'theta';...
                     'THETAplate';...
                     'THETAZernike'};
            PupilPlaneArray=cat(2,strcell,PupilPlaneArray);
            
            PupilPlaneFileName=strcat(FileName);
            writecell(PupilPlaneArray,PupilPlaneFileName,'Delimiter','comma');
            
            out = PupilPlane;
        end
        function out = update(PupilPlane,FileName)
            PupilPlaneFileName=FileName;
            PupilPlaneArray=readcell(PupilPlaneFileName);
            strcell=PupilPlaneArray(1:end,1);
            PupilPlaneArray=PupilPlaneArray(:,2:end);
            PupilPlaneArray=cell2mat(PupilPlaneArray);
            for ii=1:numel(strcell)
                string=strcell{ii};
                switch string
                    case 'Bstar'
                        PupilPlane.Bstar=PupilPlaneArray(ii,:);
                    case 'rho'
                        PupilPlane.rho=PupilPlaneArray(ii,:);
                    case 'theta'
                        PupilPlane.theta=PupilPlaneArray(ii,:);
                    case 'THETAplate'
                        PupilPlane.THETAplate=PupilPlaneArray(ii,:);
                    case 'THETAZernike'
                        PupilPlane.THETAZernike=PupilPlaneArray(ii,:);
                end
            end
            
            out = PupilPlane;
        end
    end
end
    